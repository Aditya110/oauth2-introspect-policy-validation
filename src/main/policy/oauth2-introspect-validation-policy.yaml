# The Mulesoft out-of-the-box "OAuth 2.0 access token enforcement using external provider policy" expects
# a token validation endpoint and a return map that many OAuth2 servers don't provide in the *undocumented* 
# format expected (RFC 6749 does not define the validation endpoint implementaiton and Mulesoft doesn't
# document how they implement it).
#
# This custom policy is a replacement for that using the RFC 7662 introspect endpoint to
# both validate the Access Token and return the valid scopes and other RFC 7662 response values
# for use downstream in the API implementation. N.B. Whereas the Mulesoft policy only needs the
# Authorization Token in order to validate and introspect it, this policy additionally needs the Client ID and
# Secret, since OpenAM will only respond to an introspect that has been validated with Basic Auth
# using them.
#
# See https://docs.mulesoft.com/anypoint-studio/v/6/studio-policy-editor and
# https://docs.mulesoft.com/api-manager/creating-a-policy-walkthrough
#
# This policy requires:
#  - header Authorization: Bearer <access_token>
#  - parameters client_id and client_secret
#
# On success, it adds the following headers to the flow based on the keys in the introspection response.
#  X-AGW-scope
#  etc. TBD upon further experimentation.
#
# OpenAM endpoints are documented here:
# https://backstage.forgerock.com/#!/docs/openam/13.5/dev-guide#rest-api-oauth2-client-endpoints
#
# The introspect endpoint requires the following:
#  - method POST
#  - header Authorization: Basic <HTTPBasicAuth(client_id,client_secret)>
#  - parameter token=<access_token>
#
# This policy has been tested only with OpenAM 14.0, so might not work with other RFC 7662 implementations.
#
# Copyright (c) 2016 The Trustees of Columbia University in the City of New York
#
name: OAuth 2.0 Access Token Introspection Policy
description: |
  Validates OAuth 2.0 Authorization token using the RFC 7662 introspect endpoint.
  Returns scope, sub, userid, etc. (see [RFC 7662](https://tools.ietf.org/html/rfc7662#page-6)).
  This policy will require updates to the RAML definition in order to function. You can obtain the oauth_2_0 security scheme RAML snippet [here](https://github.com/raml-org/raml-spec/blob/master/versions/raml-08/raml-08.md#security),
  the securedBy snippet [here](https://github.com/raml-org/raml-spec/blob/master/versions/raml-08/raml-08.md#usage-applying-a-security-scheme-to-an-api), and the client-id-required trait [here](https://docs.mulesoft.com/api-manager/client-id-based-policies).
id: oauth2-token-introspection
providedCharacteristics: 
  - OAuth 2.0 protected
requiredCharacteristics:
  - Client ID required
requiresConnectivity: true
standalone: true
type: custom
category: Security
configuration:
  - 
    propertyName: introspectPath
    name: Introspect Path
    description: OAuth 2.0 introspect endoint path
    sensitive: false
    type: string
    defaultValue: openam/oauth2/introspect
    optional: false
  - 
    propertyName: OAuthProto
    name: OAuth protocol
    description: OAuth 2.0 server protocol (HTTP or HTTPS)
    sensitive: false
    type: string
    defaultValue: HTTPS
    optional: false
  -
    propertyName: OAuthHost
    name: OAuth host
    description: OAuth 2.0 server host
    sensitive: false
    type: string
    optional: false
  - 
    propertyName: OAuthPort
    name: OAuth port
    description: OAuth 2.0 introspect endoint port
    sensitive: false
    type: int
    minimumValue: 1
    maximumValue: 65535
    defaultValue: 8443
    optional: false
  - 
    propertyName: insecure
    name: insecure TLS context (use for testing only)
    description: Transport Layer Security certificate validation
    sensitive: false
    type: boolean
    defaultValue: true
    optional: true
  - 
    propertyName: scopes
    name: Required scopes
    description: OAuth 2.0 required scopes (leave blank if none)
    sensitive: false
    type: string
    optional: true   